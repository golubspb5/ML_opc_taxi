"""
–ú–æ–¥—É–ª—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—É—â–µ–Ω–Ω–æ–≥–æ Uber API —Å–µ—Ä–≤–∏—Å–∞.

–≠—Ç–∏ —Ç–µ—Å—Ç—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç:
1. –ß—Ç–æ Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
2. –ß—Ç–æ –≤—Å–µ endpoints API —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å —Ä–µ–∞–ª—å–Ω–æ–π –º–æ–¥–µ–ª—å—é
3. –ß—Ç–æ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –≤ –æ–∂–∏–¥–∞–µ–º–æ–º —Ñ–æ—Ä–º–∞—Ç–µ

–í–ê–ñ–ù–û: –≠—Ç–∏ —Ç–µ—Å—Ç—ã –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –ø—Ä–æ—Ç–∏–≤ –†–ï–ê–õ–¨–ù–û–ì–û —Å–µ—Ä–≤–∏—Å–∞, —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ–≥–æ –≤ Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ.
"""

import pytest
import requests
import time

# –ë–∞–∑–æ–≤—ã–π URL —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
# –°–µ—Ä–≤–∏—Å –∑–∞–ø—É—â–µ–Ω –≤ Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –∏ –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ localhost –ø–æ—Ä—Ç 32000
BASE_URL = "http://localhost:32000"

# –í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –ø–æ–¥–Ω—è—Ç–∏—è —Å–µ—Ä–≤–∏—Å–∞ (–≤ —Å–µ–∫—É–Ω–¥–∞—Ö)
SERVICE_STARTUP_TIMEOUT = 30


def wait_for_service_to_be_ready(timeout_seconds=SERVICE_STARTUP_TIMEOUT):
    """
    –û–∂–∏–¥–∞–µ—Ç –ø–æ–∫–∞ —Å–µ—Ä–≤–∏—Å –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –∏ —Å—Ç–∞–Ω–µ—Ç –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –∑–∞–ø—Ä–æ—Å—ã.
    
    –ó–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ:
    - Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤—Ä–µ–º—è –Ω–∞ –∑–∞–ø—É—Å–∫ (–∑–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è FastAPI)
    - –ú—ã –¥–æ–ª–∂–Ω—ã —É–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ —Å–µ—Ä–≤–∏—Å –≥–æ—Ç–æ–≤ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —Ç–µ—Å—Ç–æ–≤
    - –ò–∑–±–µ–≥–∞–µ–º –ª–æ–∂–Ω—ã—Ö –ø–∞–¥–µ–Ω–∏–π —Ç–µ—Å—Ç–æ–≤ –∏–∑-–∑–∞ —Ç–æ–≥–æ —á—Ç–æ —Å–µ—Ä–≤–∏—Å –µ—â—ë –Ω–µ –≥–æ—Ç–æ–≤
    
    Args:
        timeout_seconds (int): –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
        
    Returns:
        bool: True –µ—Å–ª–∏ —Å–µ—Ä–≤–∏—Å –∑–∞–ø—É—Å—Ç–∏–ª—Å—è, False –µ—Å–ª–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è
    """
    print(f"‚è≥ –û–∂–∏–¥–∞–µ–º –∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞ (–º–∞–∫—Å–∏–º—É–º {timeout_seconds} —Å–µ–∫—É–Ω–¥)...")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–∏—Å–∞ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É –≤ —Ç–µ—á–µ–Ω–∏–µ timeout_seconds
    for attempt in range(timeout_seconds):
        try:
            # –ü—ã—Ç–∞–µ–º—Å—è –≤—ã–ø–æ–ª–Ω–∏—Ç—å GET –∑–∞–ø—Ä–æ—Å –∫ –∫–æ—Ä–Ω–µ–≤–æ–º—É endpoint
            response = requests.get(f"{BASE_URL}/")
            
            # –ï—Å–ª–∏ –ø–æ–ª—É—á–∏–ª–∏ —Å—Ç–∞—Ç—É—Å 200 - —Å–µ—Ä–≤–∏—Å –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ
            if response.status_code == 200:
                print(f"‚úÖ –°–µ—Ä–≤–∏—Å —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –ø–æ—Å–ª–µ {attempt + 1} —Å–µ–∫—É–Ω–¥")
                return True
                
        except (requests.ConnectionError, requests.Timeout) as error:
            # –°–µ—Ä–≤–∏—Å –µ—â—ë –Ω–µ –≥–æ—Ç–æ–≤ –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –≤ –Ω–∞—á–∞–ª–µ
            if attempt % 5 == 0:  # –õ–æ–≥–∏—Ä—É–µ–º –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥ —á—Ç–æ–±—ã –Ω–µ –∑–∞—Å–æ—Ä—è—Ç—å –≤—ã–≤–æ–¥
                print(f"üîÑ –°–µ—Ä–≤–∏—Å –µ—â—ë –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω, –ø–æ–ø—ã—Ç–∫–∞ {attempt + 1}/{timeout_seconds}...")
        
        # –ñ–¥—ë–º 1 —Å–µ–∫—É–Ω–¥—É –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–æ–π
        time.sleep(1)
    
    # –ï—Å–ª–∏ –¥–æ—à–ª–∏ –¥–æ —ç—Ç–æ–π —Ç–æ—á–∫–∏ - —Å–µ—Ä–≤–∏—Å –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –∑–∞ –æ—Ç–≤–µ–¥—ë–Ω–Ω–æ–µ –≤—Ä–µ–º—è
    print(f"‚ùå –°–µ—Ä–≤–∏—Å –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –∑–∞ {timeout_seconds} —Å–µ–∫—É–Ω–¥")
    return False


def test_service_starts_successfully():
    """
    –¢–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —á—Ç–æ Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å API —Å–µ—Ä–≤–∏—Å–æ–º —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è.
    
    –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–π –ø–µ—Ä–≤—ã–π —Ç–µ—Å—Ç - –µ—Å–ª–∏ –æ–Ω –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç, 
    –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã –±—É–¥—É—Ç –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω—ã.
    """
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–µ—Ä–≤–∏—Å –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤ —Ç–µ—á–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
    service_is_ready = wait_for_service_to_be_ready(SERVICE_STARTUP_TIMEOUT)
    
    # –£—Ç–≤–µ—Ä–∂–¥–∞–µ–º —á—Ç–æ —Å–µ—Ä–≤–∏—Å –¥–æ–ª–∂–µ–Ω –±—ã–ª –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è
    assert service_is_ready, (
        f"API —Å–µ—Ä–≤–∏—Å –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –∑–∞ {SERVICE_STARTUP_TIMEOUT} —Å–µ–∫—É–Ω–¥. "
        "–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:\n"
        "1. Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è\n"
        "2. –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–æ–¥–µ–ª–∏ –º–∞—à–∏–Ω–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è\n" 
        "3. –ü–æ—Ä—Ç 32000 –∑–∞–Ω—è—Ç –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º\n"
        "4. –û—à–∏–±–∫–∞ –≤ –∫–æ–¥–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
    )


def test_root_endpoint_returns_correct_response():
    """
    –¢–µ—Å—Ç–∏—Ä—É–µ—Ç –∫–æ—Ä–Ω–µ–≤–æ–π endpoint API (/).
    
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —á—Ç–æ:
    - Endpoint –æ—Ç–≤–µ—á–∞–µ—Ç —Å—Ç–∞—Ç—É—Å–æ–º 200 OK
    - –û—Ç–≤–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–∂–∏–¥–∞–µ–º—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É JSON
    - –ü–æ–ª—è 'status' –∏ 'message' –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç –∏ —Å–æ–¥–µ—Ä–∂–∞—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    """
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º GET –∑–∞–ø—Ä–æ—Å –∫ –∫–æ—Ä–Ω–µ–≤–æ–º—É URL —Å–µ—Ä–≤–∏—Å–∞
    response = requests.get(f"{BASE_URL}/")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—Ç–∏–ª —É—Å–ø–µ—à–Ω—ã–º —Å—Ç–∞—Ç—É—Å–æ–º
    assert response.status_code == 200, (
        f"–ö–æ—Ä–Ω–µ–≤–æ–π endpoint –≤–µ—Ä–Ω—É–ª —Å—Ç–∞—Ç—É—Å {response.status_code} –≤–º–µ—Å—Ç–æ 200. "
        f"–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: {response.text}"
    )
    
    # –ü–∞—Ä—Å–∏–º JSON —Ç–µ–ª–æ –æ—Ç–≤–µ—Ç–∞
    response_body = response.json()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ø–æ–ª—è 'status'
    assert "status" in response_body, (
        "–û—Ç–≤–µ—Ç –∫–æ—Ä–Ω–µ–≤–æ–≥–æ endpoint –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø–æ–ª–µ 'status'. "
        f"–ü–æ–ª—É—á–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç: {response_body}"
    )
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å—Ç–∞—Ç—É—Å —Ä–∞–≤–µ–Ω "ok"
    assert response_body["status"] == "ok", (
        f"–ü–æ–ª–µ 'status' –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 'ok', –Ω–æ –ø–æ–ª—É—á–µ–Ω–æ: '{response_body['status']}'"
    )
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ø–æ–ª—è 'message'  
    assert "message" in response_body, (
        "–û—Ç–≤–µ—Ç –∫–æ—Ä–Ω–µ–≤–æ–≥–æ endpoint –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø–æ–ª–µ 'message'. "
        f"–ü–æ–ª—É—á–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç: {response_body}"
    )
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç Uber —Å–µ—Ä–≤–∏—Å
    assert "Uber" in response_body["message"], (
        "–ü–æ–ª–µ 'message' –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å 'Uber' –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å–µ—Ä–≤–∏—Å–∞. "
        f"–ü–æ–ª—É—á–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: '{response_body['message']}'"
    )


def test_predict_endpoint_with_real_model():
    """
    –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç endpoint –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π —Å –†–ï–ê–õ–¨–ù–û–ô –º–æ–¥–µ–ª—å—é –º–∞—à–∏–Ω–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è.
    
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª —Ä–∞–±–æ—Ç—ã:
    - –û—Ç–ø—Ä–∞–≤–∫–∞ –≤–∞–ª–∏–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–µ–∑–¥–∫–µ
    - –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ —Ä–µ–∞–ª—å–Ω–æ–π –º–æ–¥–µ–ª—å—é
    - –í–æ–∑–≤—Ä–∞—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è —Ü–µ–Ω—ã
    
    –≠—Ç–æ —Å–∞–º—ã–π –≤–∞–∂–Ω—ã–π —Ç–µ—Å—Ç - –æ–Ω –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –æ—Å–Ω–æ–≤–Ω—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
    """
    # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è —Ü–µ–Ω—ã –ø–æ–µ–∑–¥–∫–∏
    # –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é—Ç —Ä–µ–∞–ª—å–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç –≤ –ù—å—é-–ô–æ—Ä–∫–µ:
    test_payload = {
        "data": [{
            "pickup_latitude": 40.761432,      # –®–∏—Ä–æ—Ç–∞ —Ç–æ—á–∫–∏ –ø–æ—Å–∞–¥–∫–∏ (—Ä–∞–π–æ–Ω –ú–∞–Ω—Ö—ç—Ç—Ç–µ–Ω)
            "pickup_longitude": -73.977621,    # –î–æ–ª–≥–æ—Ç–∞ —Ç–æ—á–∫–∏ –ø–æ—Å–∞–¥–∫–∏
            "dropoff_latitude": 40.641311,     # –®–∏—Ä–æ—Ç–∞ —Ç–æ—á–∫–∏ –≤—ã—Å–∞–¥–∫–∏ (–∞—ç—Ä–æ–ø–æ—Ä—Ç JFK)
            "dropoff_longitude": -73.778137,   # –î–æ–ª–≥–æ—Ç–∞ —Ç–æ—á–∫–∏ –≤—ã—Å–∞–¥–∫–∏
            "passenger_count": 2               # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤
        }]
    }

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º POST –∑–∞–ø—Ä–æ—Å –∫ endpoint –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π
    response = requests.post(f"{BASE_URL}/api/predict/", json=test_payload)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –ø—Ä–∏–Ω—è–ª –∑–∞–ø—Ä–æ—Å –∏ –æ–±—Ä–∞–±–æ—Ç–∞–ª –µ–≥–æ —É—Å–ø–µ—à–Ω–æ
    assert response.status_code == 200, (
        f"Endpoint /api/predict/ –≤–µ—Ä–Ω—É–ª —Å—Ç–∞—Ç—É—Å {response.status_code} –≤–º–µ—Å—Ç–æ 200. "
        f"–¢–µ–ª–æ –æ—à–∏–±–∫–∏: {response.text}\n"
        "–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:\n"
        "1. –ú–æ–¥–µ–ª—å –º–∞—à–∏–Ω–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞\n"
        "2. –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö\n"
        "3. –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–∏"
    )

    # –ü–∞—Ä—Å–∏–º JSON –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
    response_data = response.json()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –æ—Ç–≤–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª–µ 'predictions'
    assert "predictions" in response_data, (
        "–û—Ç–≤–µ—Ç endpoint –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø–æ–ª–µ 'predictions'. "
        f"–ü–æ–ª—É—á–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç: {response_data}"
    )
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ 'predictions' —è–≤–ª—è–µ—Ç—Å—è —Å–ø–∏—Å–∫–æ–º
    assert isinstance(response_data["predictions"], list), (
        f"–ü–æ–ª–µ 'predictions' –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å–ø–∏—Å–∫–æ–º, –Ω–æ –ø–æ–ª—É—á–µ–Ω {type(response_data['predictions'])}. "
        f"–ó–Ω–∞—á–µ–Ω–∏–µ: {response_data['predictions']}"
    )
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–ø–∏—Å–æ–∫ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π –Ω–µ –ø—É—Å—Ç–æ–π
    assert len(response_data["predictions"]) > 0, (
        "–°–ø–∏—Å–æ–∫ 'predictions' –Ω–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—É—Å—Ç—ã–º. "
        "–°–µ—Ä–≤–∏—Å –¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ."
    )
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–µ—Ä–≤–æ–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ —è–≤–ª—è–µ—Ç—Å—è —á–∏—Å–ª–æ–º —Å –ø–ª–∞–≤–∞—é—â–µ–π —Ç–æ—á–∫–æ–π
    first_prediction = response_data["predictions"][0]
    assert isinstance(first_prediction, float), (
        f"–ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å float, –Ω–æ –ø–æ–ª—É—á–µ–Ω {type(first_prediction)}. "
        f"–ó–Ω–∞—á–µ–Ω–∏–µ: {first_prediction}"
    )
    
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º
    # (—Ü–µ–Ω–∞ –ø–æ–µ–∑–¥–∫–∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–π)
    assert first_prediction > 0, (
        f"–ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ —Ü–µ–Ω—ã –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º, –Ω–æ –ø–æ–ª—É—á–µ–Ω–æ: {first_prediction}"
    )
    
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–º
    # (–æ–±—ã—á–Ω–æ –ø–æ–µ–∑–¥–∫–∏ –≤ –ù—å—é-–ô–æ—Ä–∫–µ —Å—Ç–æ—è—Ç –æ—Ç $3 –¥–æ $100+)
    assert 3.0 <= first_prediction <= 150.0, (
        f"–ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ —Ü–µ–Ω—ã {first_prediction} –≤—ã–≥–ª—è–¥–∏—Ç –Ω–µ—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ –¥–ª—è –ø–æ–µ–∑–¥–∫–∏ –≤ –ù—å—é-–ô–æ—Ä–∫–µ. "
        "–û–∂–∏–¥–∞–µ—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏–µ –º–µ–∂–¥—É $3 –∏ $150."
    )
    
    # –í—ã–≤–æ–¥–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    print(f"‚úÖ –ú–æ–¥–µ–ª—å —É—Å–ø–µ—à–Ω–æ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–ª–∞ —Ü–µ–Ω—É –ø–æ–µ–∑–¥–∫–∏: ${first_prediction:.2f}")


def test_predict_with_multiple_rides():
    """
    –¢–µ—Å—Ç–∏—Ä—É–µ—Ç endpoint –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –ø–æ–µ–∑–¥–∫–∞–º–∏ –≤ –æ–¥–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ.
    
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —á—Ç–æ API –º–æ–∂–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –±–∞—Ç—á-–∑–∞–ø—Ä–æ—Å—ã –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç
    –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã—Ö –ø–æ–µ–∑–¥–æ–∫.
    """
    # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —Å —Ç—Ä–µ–º—è —Ä–∞–∑–Ω—ã–º–∏ –ø–æ–µ–∑–¥–∫–∞–º–∏
    test_payload = {
        "data": [
            {
                "pickup_latitude": 40.758896,    # –¢–∞–π–º—Å-—Å–∫–≤–µ—Ä
                "pickup_longitude": -73.985130,
                "dropoff_latitude": 40.689200,   # –°—Ç–∞—Ç—É—è –°–≤–æ–±–æ–¥—ã (–ø–∞—Ä–æ–º)
                "dropoff_longitude": -74.044500,
                "passenger_count": 1
            },
            {
                "pickup_latitude": 40.750500,    # –ü–µ–Ω—Å–∏–ª—å–≤–∞–Ω—Å–∫–∏–π –≤–æ–∫–∑–∞–ª
                "pickup_longitude": -73.993400,
                "dropoff_latitude": 40.728200,   # –ò—Å—Ç-–í–∏–ª–ª–∏–¥–∂
                "dropoff_longitude": -73.984200, 
                "passenger_count": 3
            },
            {
                "pickup_latitude": 40.817600,    # –í–µ—Ä—Ö–Ω–∏–π –ú–∞–Ω—Ö—ç—Ç—Ç–µ–Ω
                "pickup_longitude": -73.936000,
                "dropoff_latitude": 40.706100,   # –£–æ–ª–ª-—Å—Ç—Ä–∏—Ç (—Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ä–∞–π–æ–Ω)
                "dropoff_longitude": -74.008800,
                "passenger_count": 2
            }
        ]
    }

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –±–∞—Ç—á-–∑–∞–ø—Ä–æ—Å —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –ø–æ–µ–∑–¥–∫–∞–º–∏
    response = requests.post(f"{BASE_URL}/api/predict/", json=test_payload)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç
    assert response.status_code == 200, (
        f"–ë–∞—Ç—á-–∑–∞–ø—Ä–æ—Å –≤–µ—Ä–Ω—É–ª —Å—Ç–∞—Ç—É—Å {response.status_code}. –¢–µ–ª–æ –æ—à–∏–±–∫–∏: {response.text}"
    )
    
    response_data = response.json()
    assert "predictions" in response_data, "–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å predictions"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –≤—Ö–æ–¥–Ω—ã—Ö –ø–æ–µ–∑–¥–æ–∫
    expected_predictions_count = len(test_payload["data"])
    actual_predictions_count = len(response_data["predictions"])
    
    assert actual_predictions_count == expected_predictions_count, (
        f"–û–∂–∏–¥–∞–ª–æ—Å—å {expected_predictions_count} –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π, "
        f"–Ω–æ –ø–æ–ª—É—á–µ–Ω–æ {actual_predictions_count}"
    )
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤—Å–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è —è–≤–ª—è—é—Ç—Å—è —á–∏—Å–ª–∞–º–∏ –∏ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–º–∏
    for i, prediction in enumerate(response_data["predictions"]):
        assert isinstance(prediction, float), (
            f"–ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ #{i+1} –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å float, –Ω–æ –ø–æ–ª—É—á–µ–Ω {type(prediction)}"
        )
        assert prediction > 0, (
            f"–ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ #{i+1} –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º, –Ω–æ –ø–æ–ª—É—á–µ–Ω–æ {prediction}"
        )
        print(f"‚úÖ –ü–æ–µ–∑–¥–∫–∞ #{i+1}: –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω–∞—è —Ü–µ–Ω–∞ ${prediction:.2f}")